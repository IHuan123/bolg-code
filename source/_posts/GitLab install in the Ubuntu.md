---
title: 安装使用GitLab。
toc: true
date: 2022-03-24 10:22:29GitLab install in the Ubuntu
tags: [JavaSciprt]
urlname:
categories: [JavaSciprt]
recommend:
cover:
keywords: gitlab,GitLab。
top: 3
---

如何安装gitlab？
<!-- more -->
这里我使用ubuntu系统进行安装。

## 下载gitlab

### 安装依赖

```shell
sudo apt-get update
sudo apt-get install -y curl openssh-server ca-certificates
```

### 安装gitlab

在线安装命令

```shell
curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash
sudo apt-get install gitlab-ce
```

离线下载

官网下载包，地址：https://packages.gitlab.com/gitlab/gitlab-ce

注意的：ubuntu/focal 适用于 ubuntu20系列，ubuntu/bionic 适用于 ubuntu18 系列，我这里下载的是ubuntu/focal  gitlab-ce_15.10.2-ce.0_amd64.deb版本

3.3 安装gitlab-ce_15.10.2-ce.0_amd64.deb

将下载的gitlab-ce_15.10.2-ce.0_amd64.deb离线安装包上传到服务器上，进入文件目录，使用下面命令安装离线包
```shell
apt install ./gitlab-ce_15.10.2-ce.0_amd64.deb
```

## **安装完成进行配置** 

1、修改配置

修改[配置文件](https://so.csdn.net/so/search?q=配置文件&spm=1001.2101.3001.7020)gitlab.rb：找到已经注释掉的# external_url 'http://gitlab.example.com'，修改为下面的

```shell
sudo vim /etc/gitlab/gitlab.rb
external_url 'http://www.test.com'  # 这里可以使用服务器的公网ip或域名加端口（端口与下面nginx['listen_port']的配置保持一致）
```

修改配置文件gitlab.rb，搜索注释掉的nginx['listen_port']，修改为9999端口（端口与上面external_url 的端口保持一致）

```shell
sudo vim /etc/gitlab/gitlab.rb
```

```rb
##! You can run `gitlab-ctl show-config` to display the configuration that will be generated by
##! running `gitlab-ctl reconfigure`

##! In general, the values specified here should reflect what the default value of the attribute will be.
##! There are instances where this behavior is not possible or desired. For example, when providing passwords,
##! or connecting to third party services.
##! In those instances, we endeavour to provide an example configuration.

## GitLab URL
##! URL on which GitLab will be reachable.
##! For more details on configuring external_url see:
##! https://docs.gitlab.com/omnibus/settings/configuration.html#configuring-the-external-url-for-gitlab
##!
##! Note: During installation/upgrades, the value of the environment variable
##! EXTERNAL_URL will be used to populate/replace this value.
##! On AWS EC2 instances, we also attempt to fetch the public hostname/IP
##! address from AWS. For more details, see:
##! https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html
#配置地址端口
external_url 'http://10.211.55.10:5678'
#配置nginx的端口号9999
nginx['listen_port'] = 9999
```

**注意这里配置的external_url和nginx['listen_port']端口，两者需要最好一致，如果你配置了系统邮箱功能，当你在gitlab里导出项目时会有一个带有超链接的下载邮箱发往你的邮箱，这个链接就是external_url的地址。点击这个下载链接时，如果端口不一致会打不开，但貌似其他功能不受影响**

2、保存重新载入配置设置开机自启动

```shell
# /opt/gitlab/bin/当前文件目录下包含gitlab使用的命令程序
cd /opt/gitlab/bin/ 
sudo gitlab-ctl reconfigure # 使用已修改的配置
# 服务器开启时自动启动gitlab
sudo systemctl enable gitlab-runsvdir.service
```

3、查看状态

```shell
sudo gitlab-ctl status

# 显示下面信息则表示服务已经启动
root@hecs-230323:/opt/gitlab/bin# sudo gitlab-ctl status
run: gitaly: (pid 4725) 2237s; run: log: (pid 1200) 5991s
run: gitlab-kas: (pid 4755) 2226s; run: log: (pid 1189) 5991s
run: gitlab-workhorse: (pid 4761) 2226s; run: log: (pid 1201) 5991s
run: logrotate: (pid 4774) 2225s; run: log: (pid 1198) 5991s
......
```

## 进入gitlab

1、使用ip或者域名加端口号打开，端口在`/etc/gitlab/gitlab.rb`中配置，例如：`http://10.211.55.10:5678`

![img](/images/gitlab-login.png)

出现这个页面就说明GitLab安装成功了！

2、使用root初始账号进行登录

查看root账号密码可以在`/etc/gitlab/initial_root_password`中进行查看`cat /etc/gitlab/initial_root_password`，将文件中`Password: rYw1D6i538oQMIYrO5RZz/ivh1hoIKeByNEa0pvYvNs=`复制到登录页面进行登录**（24小时有效）**。

3、修改密码

![image-20241202181109324](/images/update-account.png)

4、gitlab注册新用户，用该账号登录时需要管理员激活才能登录。

5、多语言设置，在Prefernece中进行设置。

## gitlab内存优化

如果gitlab使用默认配置会占用很大一部分内存，如果内存比较小就会导致服务器卡顿，这就需要调整gitlab配置，更改`/etc/gitlab/gitlab.rb`中的配置`vim /etc/gitlab/gitlab.rb`，如果没有权限就是用sudo。

调整配置

```rb
# 减少数据库缓存
postgresql['shared_buffers'] = "64MB"
# 减少数据库并发数
postgresql['max_worker_processes'] = 4
# 禁用puma cluster模式，可以减少100-400MB占用
puma['worker_processes'] = 0
# 减少sidekiq并发数
# sidekiq['concurrency'] = 2
sidekiq['max_concurrency'] = 2
# 禁用监控
prometheus_monitoring['enable'] = false
# 减少gitlab_rails组件的内存消耗
gitlab_rails['env'] = {
  'MALLOC_CONF' => 'dirty_decay_ms:500,muzzy_decay_ms:500'
}
```

![](/images/gitlab-config.png)

保存添加的配置，重载配置并重启

```sh
cd /opt/gitlab/bin/
sudo gitlab-ctl reconfigure
sudo gitlab-ctl restart
```

## 常用的命令

```
gitlab配置文件位置： /etc/gitlab/gitlab.rb
停止gitlab服务 sudo gitlab-ctl stop ​
启动gitlab服务 sudo gitlab-ctl reconfigure ​
重启所有gitlab组件 sudo gitlab-ctl restart ​
启动所有gitlab组件 sudo gitlab-ctl start
查看gitlab运行状态 sudo gitlab-ctl status
启用开机自启动sudo systemctl enable gitlab-runsvdir.service
```

## ssl证书

1、将下载好的证书上传至`/etc/gitlab/ssl`这个目录下；

2、配置gitlab `vi /etc/gitlab/gitlab.rb`;

3、添加配置

```
external_url 'https://example.com:9999'  # 修改之前配置的http为https

nginx['enable'] = true
nginx['ssl_certificate'] = "/etc/gitlab/ssl/xxx.com_server.crt"
nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/xxx.com_server.key"
```

配置好后重新保存配置，`gitlab-ctl reconfigure`，这样就可以直接使用https进行访问了。
